---
title: "Understanding GM control strategy effects"
author: "David O'Sullivan"
date: "04/06/2022"
output:
  html_document: default
  pdf_document: default
---

## Findings
As detailed in the following:

+ Even extended control programs if not pursued to eradication (which is very difficult) are no more successful than a 'release-once-and-forget' strategy (`periodicity` 0)
+ Eradication is possible, but is only achieved with 'release everywhere' (`grid_resolution` 1) strategies; note that release everywhere is relative to the model resolution, meaning one release site every 1km -- in practice a finer grid even than this would probably be required!
+ The number of GM wasps released (`colonies_per_site`) only marginally increases the chances of success; the main effect of releasing more wasps is to accelerate the initial decrease in wasp population
+ Modulating releases spatial (the 'spatial' strategy, ie release every year at every nth site) is more detrimental to success than modulating temporally (the 'temporal' strategy, ie release everywhere every nth year)
+ Long term outcomes may sensitively depend on when a control strategy is stopped; in particular, it is possible for seemingly very low populations to make a full recovery if GM populations are so small as to be vulnerable to extinction in the population: this means that highly accurate monitoring (that could detect possible very small and remote refugial populations) or extremely conservative settings (i.e. continuing releases long after they might seem to be necessary) or both would be required for reliable eradication. 


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(tidyr)
library(tibble)
library(ggplot2)
library(janitor)
```

# Read and clean the data
And clean up all the NetLogo name weirdness

```{r}
wasps <- read.csv(
  "wasps GRID-RELEASE-EXPERIMENT-table.csv", skip = 6) %>%
  clean_names() %>%
  rename(run_number = x_run_number, t = x_step, 
         strategy = spatial_or_temporal) %>%
  mutate(total_wild = total_pop - total_gm - total_sterile) %>%
  mutate(program_duration = as.factor(program_duration))
# %>%
#   arrange(sample(seq_len(nrow(.)), nrow(.)))
```
## Standardise population figures to start populations.

```{r}
start_pops <- wasps %>%
  filter(t == 0) %>%
  select(run_number, total_pop, total_wild, total_gm, total_sterile) %>%
  rename(pop_0 = total_pop, wild_0 = total_wild, gm_0 = total_gm, sterile_0 = total_sterile)
# and join to the data and calculate populations relative to start pop
wasps <- wasps %>%
  merge(start_pops, all.x = TRUE) %>%
  mutate(pop_t = total_pop / pop_0,
         wild_t = total_wild / wild_0,
         gm_t = total_gm / gm_0)
```

# Eradication success
First we tag scenarios where eradication has occurred, which are those that end prematurely before 150 years are elapsed.

```{r}
end_time <- wasps %>%
  group_by(run_number) %>% 
  summarise(max_t = max(t))
wasps <- wasps %>%
  merge(end_time) %>%
  mutate(eradication = max_t < 150)
```

Now we can make a plot showing eradication success rate relative to different control program settings.

```{r}
wasps %>% 
  select(eradication, strategy, 
         colonies_per_site, grid_resolution, periodicity) %>%
  group_by(strategy, colonies_per_site, 
           grid_resolution, periodicity) %>%
  summarise(success = sum(eradication) / n()) %>%
  mutate(periodicity = as.factor(periodicity),
         grid_resolution = as.factor(grid_resolution)) %>%
  ggplot() +
    geom_tile(aes(x = grid_resolution, y = periodicity, fill = success)) + 
    scale_fill_distiller(palette = "Greens", direction = 1) + 
    facet_grid(strategy ~ colonies_per_site, 
               labeller = label_both) +
    ggtitle("Eradication success by grid resolution and periodicity",
            subtitle = "Also showing different combinations of colonies per site and spatial vs temporal strategies") +
    labs(x = "Release site grid resolution", y = "Periodicity", fill = "Success")
```

There are two broad strategies in these results, where the interpretation of the `periodicity` setting is slightly different:

+ "temporal" (the top row) where every site in the grid of release sites is activated every nth year, with n given by the periodicity; or
+ "spatial", (the bottom row) where the `periodicity` factor denotes that the chosen grid of release sites is activated every year, but only at every nth site, where n is again the periodicity

Note that `periodicity` 0 in both cases is a 'release once and forget strategy, which never achieves eradication in either case.

From the above plots, overall the "temporal" strategies are more successful. However in both cases, eradication only occur when `grid_resolution` is 1, i.e. a very dense network of release sites would be required. Spatial strategies furthermore only rarely achieve eradication when the `periodicity` is other than 1 (i.e. every site). This suggests that the key determinant of eradication is 'flooding' the entire landscape regularly, reducing the chance for wild populations to escape from the introduced GM wasps.

In the temporal strategies there is an increased chance of eradication when more colonies are released per site, such that even if releases only occur every 4 years eradication is still possible at high levels of releases.

## Impact of duration of control program
The above data summarise results across all experimental runs regardless of the duration of the control program, which was set to either 20 or 30 years in our experiments. By splitting out the results into the spatial and temporal strategies, we can see if this option has an impact on eradication success rates (spoilers: it does, but it is not easily seen in the summary results...).

First, split the data by spatial vs temporal strategy.

```{r}
wasps_s <- wasps %>% 
  filter(strategy == "spatial")
wasps_t <- wasps %>% 
  filter(strategy == "temporal")
```

And rerun the analysis. First for the "spatial" strategy...

```{r}
wasps_s %>% 
  select(eradication, program_duration, 
         colonies_per_site, grid_resolution, periodicity) %>%
  group_by(program_duration, colonies_per_site, 
           grid_resolution, periodicity) %>%
  summarise(success = sum(eradication) / n()) %>%
  mutate(periodicity = as.factor(periodicity),
         grid_resolution = as.factor(grid_resolution)) %>%
  ggplot() +
    geom_tile(aes(x = grid_resolution, y = periodicity, fill = success)) + 
    scale_fill_distiller(palette = "Greens", direction = 1) + 
    facet_grid(program_duration ~ colonies_per_site, labeller = label_both) +
    ggtitle("Eradication success by grid resolution and periodicity: 'spatial' strategy",
            subtitle = "Showing different combinations of colonies per site and program duration") +
    labs(x = "Release site grid resolution", y = "Periodicity", fill = "Success")
```

... and for the "temporal" strategy...

```{r}
wasps_t %>% 
  select(eradication, program_duration, 
         colonies_per_site, grid_resolution, periodicity) %>%
  group_by(program_duration, colonies_per_site, 
           grid_resolution, periodicity) %>%
  summarise(success = sum(eradication) / n()) %>%
  mutate(periodicity = as.factor(periodicity),
         grid_resolution = as.factor(grid_resolution)) %>%
  ggplot() +
    geom_tile(aes(x = grid_resolution, y = periodicity, fill = success)) + 
    scale_fill_distiller(palette = "Greens", direction = 1) + 
    facet_grid(program_duration ~ colonies_per_site, labeller = label_both) +
    ggtitle("Eradication success by grid resolution and periodicity: 'temporal' strategy",
            subtitle = "Showing different combinations of colonies per site and program duration") +
    labs(x = "Release site grid resolution", y = "Periodicity", fill = "Success")
```

The overall picture seems not much affected by the duration of the control program. The apparent anomaly of a longer control program duration being occasionally more successful than a shorter program is discussed in the section [Sensitivity of success to program duration](#sensitivity-of-success-to-program-duration) below.


# Time series visualizations
To try to understand better what's going on, we now look at time series evolution of the total wild wasp population relative to the initial population.

```{r}
ggplot(wasps) +
  geom_line(aes(x = t, y = wild_t, colour = program_duration,
                group = run_number), alpha = 0.25) +
  scale_colour_brewer(palette = "Set1") +
  facet_grid(grid_resolution ~ periodicity, scales = "free_x",
             labeller = labeller(.rows = label_both, .cols = label_both)) +
  ggtitle("All data") + 
  labs(x = "Time, years", y = "Wild population relative to start") +
  theme(legend.position = "bottom")
```
There is a lot going on here, which is challenging to parse out, when showing _all the data_ as above:

+ The finding that `grid_resolution` 1 and `periodicity` 1 combinations are 100% successful at eradication is confirmed. 
+ A second important finding is that in almost all other scenarios the eventual equilibrium population of wild wasps is substantially reduced, albeit after at least 20 years. 
+ Importantly, even `periodicity` 0 scenarios, i.e. 'release once and forget` achieve this outcome, even if more slowly (after 50-60 years).

Using all the data as above makes it hard to discern specific effects of different scenario parameters. So below, we consider subsets of the data to try to better understand the dynamics.


## Sensitivity of success to program duration
First we revisit the effect of the control program duration on success. This is a story of the sensitive dependence of success on when a control program is stopped.

The confusing times series in the upper right of the 'all data' time series plots, show how sensitively dependent eventual eradication success might be on small numbers of surviving wild and GM wasps in much reduced populations. To examine this, here is a closer look at the relevant plots, subdivided by spatial and temporal strategy cases (which otherwise greatly confuse the picture).

### Temporal strategy: wild wasp recovery is rare but unpredictable

```{r}
wasps_t %>% 
  filter(periodicity %in% c(2, 4), 
         grid_resolution == 1) %>%
  ggplot() +
    geom_line(aes(x = t, y = wild_t, colour = program_duration,
                  group = run_number)) +
    scale_colour_brewer(palette = "Set1") +
    facet_grid(periodicity ~ colonies_per_site, labeller = label_both) +
    labs(x = "Time, years", y = "Wild population relative to start") +
    theme(legend.position = "bottom")
```
Although `colonies_per_site` affects the initial rate of population fall, its main effect on the subsequent dynamics is as a control on the probability of dramatic recovery in wild populations. This recovery also depends on the program duration.

The most likely explanation of these effects is that the wasp population is greatly reduced for the duration of the control program, so much so that the less numerous GM wasps which depend for their persistence in the population on the presence of wild wasps, become vulnerable to extinction themselves in small populations. This could account for the otherwise confusing result that the long-term impact of a 20 year control program with low wasp release densities (bottom left plot) is _better_ than for a 30 year program. The latter reduces populations to the point where GM wasps disappear and the wild population makes a full recovery. In the 20 year program case some GM wasps persist and eventually (after another 50 years) reduce equilibrium populations to the low levels seen in other scenarios. 

The relative success of longer or shorter control programs is reversed in the middle bottom plot where stopping control after 20 years allows the wild population to recover, but 30 years is long enough to achieve eradication.

### Spatial strategy: wild wasp recovery is commonplace

```{r}
wasps_s %>% 
  filter(periodicity %in% c(2, 4), 
         grid_resolution == 1) %>%
  ggplot() +
    geom_line(aes(x = t, y = wild_t, colour = program_duration,
                  group = run_number)) +
    scale_colour_brewer(palette = "Set1") +
    facet_grid(periodicity ~ colonies_per_site, labeller = label_both) +
    labs(x = "Time, years", y = "Wild population relative to start") +
    theme(legend.position = "bottom")
```
In the case of the spatial strategy (where releases are made every year, but only at every nth site) the results are easier to parse, but again, show how sensitive eventual success is to 'knowing when to stop'. The more intense periodicity 2 scenarios ultimately see full recovery of the wild wasp population in almost all cases, while the less intense periodicity 4 scenarios settle into a low wasp population long term equilibrium.


## Effects of releasing more GM wasps at each site
Considering only `periodicity` 0 release-and-forget strategies, over their first 30 years, we can see the impact of the numbers of GM wasps released on the speed of convergence on the long term equilibrium.

```{r}
wasps %>% filter(strategy == "temporal", 
                 periodicity == 0, t <= 50) %>%
  ggplot() +
    geom_line(aes(x = t, y = wild_t, colour = as.factor(colonies_per_site),
                  group = run_number)) +
    scale_colour_viridis_d() +
    facet_wrap(~ grid_resolution, scales = "free_x", labeller = label_both) +
    ggtitle('Effect of number of releases on rate of convergence') + 
    labs(x = "Time, years", y = "Population relative to start", 
         colour = "GM Colonies released per site") +
    theme(legend.position = "bottom")
```

Similarly, in eradication scenarios, releasing more wasps accelerates the effect, although it is notable that the time to eradication is not much affected.

```{r}
wasps %>% filter(strategy == "temporal",
                 periodicity == 1, grid_resolution == 1) %>%
  ggplot() +
    geom_line(aes(x = t, y = wild_t, colour = as.factor(colonies_per_site),
                  group = run_number)) +
    scale_colour_viridis_d() +
    ggtitle('Eradication scenarios') + 
    labs(x = "Time, years", y = "Population relative to start", 
         colour = "GM Colonies released per site") +
    theme(legend.position = "bottom")
```

